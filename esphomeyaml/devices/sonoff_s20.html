<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><meta http-equiv="X-UA-Compatible"content="IE=Edge"><meta http-equiv="Content-Type"content="text/html; charset=utf-8"><title>Using With Sonoff S20 &#8212; esphomelib 1.6.2 documentation</title><link rel="stylesheet"href="../../_static/alabaster.css"type="text/css"><link rel="stylesheet"href="../../_static/pygments.css"type="text/css"><script src="../../_static/documentation_options.js"></script><script src="../../_static/jquery.js"></script><script src="../../_static/underscore.js"></script><script src="../../_static/doctools.js"></script><link rel="index"title="Index"href="../../genindex.html"><link rel="search"title="Search"href="../../search.html"><link rel="next"title="Using With Sonoff Basic"href="sonoff_basic.html"><link rel="prev"title="Using With Sonoff 4CH"href="sonoff_4ch.html"><link rel="stylesheet"href="../../_static/custom.css"type="text/css"><meta name="viewport"content="width=device-width,initial-scale=0.9,maximum-scale=0.9"><div class="document"><div class="documentwrapper"><div class="bodywrapper"><div class="body"role="main"><div class="section"id="using-with-sonoff-s20"><h1>Using With Sonoff S20<a class="headerlink"href="#using-with-sonoff-s20"title="Permalink to this headline">¶</a></h1><p>esphomeyaml can also be used with Sonoff S20 smart sockets. These devices are basically just an ESP8266 chip with a relay to control the socket, a small button on the front and a blue and green LED light.<div class="figure align-center"id="id1"><a class="reference internal image-reference"href="../../_images/sonoff_s20_header.jpg"><img alt="../../_images/sonoff_s20_header.jpg"src="../../_images/sonoff_s20_header.jpg"style="width: 75.0%;"></a><p class="caption"><span class="caption-text">Sonoff S20 Smart Socket.</span></div><p>This guide will step you through setting up your Sonoff S20 and flashing the first esphomeyaml firmware with the serial interface. After that, you will be able to upload all future firmwares with the remote Over-The-Air update process.<div class="admonition note"><p class="first admonition-title">Note<p class="last">If you’ve previously installed Sonoff-Tasmota on your Sonoff S20, you’re in luck 😀 esphomeyaml can generate a firmware binary which you can then upload via the Tasmota web interface. To see how to create this binary, skip to <a class="reference internal"href="#sonoff-s20-creating-firmware"><span class="std std-ref">Step 3: Creating Firmware</span></a>.</div><p>Since firmware version 1.6.0, iTead (the creator of this device) has removed the ability to upload a custom firmware through their own upload process. Unfortunately, that means that the only way to flash the initial esphomeyaml firmware is by physically opening the device up and using the UART interface.<div class="admonition warning"><p class="first admonition-title">Warning<p>Opening up this device can be very dangerous if not done correctly. While the device is open, you will be a single touch away from being electrocuted if the device is plugged in.<p>So, during this <em>entire</em> guide <strong>never ever</strong> plug the device in. Also, you should only do this if you know what you’re doing. If you, at any step, feel something is wrong or are uncomfortable with continuing, it’s best to just stop for your own safety.<p class="last">It’s your own responsibility to make sure everything you do during this setup process is safe.</div><p>For this guide you will need:<ul class="simple"><li>Sonoff S20 😉<li>An USB to UART Bridge for flashing the device. These can be bought on Amazon for less than 5 dollars. Note that the bridge <em>must</em> be 3.3V compatible. Otherwise you will destroy your S20.<li>Computer running esphomeyaml HassIO add-on.<li>Screwdriver to open up the S20.<li>Soldering iron and a few header pins to connect the UART interface.</ul><p>Have everything? Great! Then you can start.<div class="section"id="step-1-opening-up-the-sonoff-s20"><h2>Step 1: Opening up the Sonoff S20<a class="headerlink"href="#step-1-opening-up-the-sonoff-s20"title="Permalink to this headline">¶</a></h2><p>The first step is to open up the Sonoff S20. Note that you do not have to run the original firmware supplied with the Sonoff S20 before doing this step.<div class="admonition warning"><p class="first admonition-title">Warning<p class="last">Just to repeat this: Make <strong>absolutely sure</strong> the device is not connected to any appliance or plugged in before doing this step.</div><p>While the device is not plugged in, turn the back side so it’s facing you and unscrew the three black screws holding the back of the case together with the front.<div class="figure align-center"id="id2"><a class="reference internal image-reference"href="../../_images/sonoff_s20_screws.jpg"><img alt="../../_images/sonoff_s20_screws.jpg"src="../../_images/sonoff_s20_screws.jpg"style="width: 60.0%;"></a><p class="caption"><span class="caption-text">There are three screws on the back of the Sonoff S20.</span></div><p>After that, you should be able to remove the front cover and should be greeted by a bunch of parts.<div class="figure align-center"><a class="reference internal image-reference"href="../../_images/sonoff_s20_parts.jpg"><img alt="../../_images/sonoff_s20_parts.jpg"src="../../_images/sonoff_s20_parts.jpg"style="width: 75.0%;"></a></div></div><div class="section"id="step-2-connecting-uart"><h2>Step 2: Connecting UART<a class="headerlink"href="#step-2-connecting-uart"title="Permalink to this headline">¶</a></h2><p>We’re interested in the main part of the S20 with the green PCB. On the bottom of the PCB, you will find four unpopulated holes. These pins have the UART interface used to flash firmwares onto the device and debug issues.<div class="figure align-center"id="id3"><img alt="../../_images/sonoff_s20_pcb.jpg"src="../../_images/sonoff_s20_pcb.jpg"><p class="caption"><span class="caption-text">The UART interface of the Sonoff S20.</span></div><p>So, in order to flash our own custom firmware, we’re going to need to somehow connect the UART to USB bridge to these pins. The only way to make a good connection here is by using a soldering iron and soldering on some pin headers. On older models of the Sonoff S20, you were able to get the whole PCB out. Newer versions, however, glue the PCB onto the case to avoid people flashing custom firmwares. If the latter is the case, you will need to just solder the pin headers from above - it’s a bit difficult, but possible.<p>When you’re done, it should look something like this:<div class="figure align-center"><img alt="../../_images/sonoff_s20_uart.jpg"src="../../_images/sonoff_s20_uart.jpg"></div><p>Now go ahead and connect the pins to your UART bridge, making sure the S20 is not plugged in as before. Also beware that some UART to USB bridges supply 5V on the VCC pin if it’s not explicitly labeled 3.3V. It’s best to just use a multimeter and double check if it’s unclear.<div class="admonition note"><p class="first admonition-title">Note<p class="last">On some older S20s, the <code class="docutils literal notranslate"><span class="pre">RX</span></code> and <code class="docutils literal notranslate"><span class="pre">TX</span></code> pins are swapped (sometimes even the written silkscreen is wrong). If your upload fails with a <code class="docutils literal notranslate"><span class="pre">error:</span> <span class="pre">espcomm_upload_mem</span> <span class="pre">failed</span></code> message it’s most likely due to the pins being swapped. In that case, just swap <code class="docutils literal notranslate"><span class="pre">RX</span></code> and <code class="docutils literal notranslate"><span class="pre">TX</span></code> and try again - you won’t break anything if they’re swapped.</div></div><div class="section"id="step-3-creating-firmware"><span id="sonoff-s20-creating-firmware"></span><h2>Step 3: Creating Firmware<a class="headerlink"href="#step-3-creating-firmware"title="Permalink to this headline">¶</a></h2><p>The Sonoff S20 is based on the <code class="docutils literal notranslate"><span class="pre">ESP8266</span></code> platform and is a subtype of the <code class="docutils literal notranslate"><span class="pre">esp01_1m</span></code> board. With this information, you can step through the esphomeyaml wizard (<code class="docutils literal notranslate"><span class="pre">esphomeyaml</span> <span class="pre">sonoff_s20.yaml</span> <span class="pre">wizard</span></code>), or alternatively, you can just take the below configuration file and modify it to your needs.<p>If you go through the wizard, please make sure you manually set <code class="docutils literal notranslate"><span class="pre">board_flash_mode</span></code> to <code class="docutils literal notranslate"><span class="pre">dout</span></code> as seen below. The version of the uploader used by esphomeyaml should automatically detect that the Sonoff S20 uses the <code class="docutils literal notranslate"><span class="pre">dout</span></code> SPI flash chip mode. But, as some users of other firmwares have said that other flash modes can brick the device, it’s always good to specify it explicitly.<div class="code yaml highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">esphomeyaml</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">NAME_OF_NODE</span><span class="o">&gt;</span>
  <span class="n">platform</span><span class="p">:</span> <span class="n">ESP8266</span>
  <span class="n">board</span><span class="p">:</span> <span class="n">esp01_1m</span>
  <span class="n">board_flash_mode</span><span class="p">:</span> <span class="n">dout</span>

<span class="n">wifi</span><span class="p">:</span>
  <span class="n">ssid</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">YOUR_SSID</span><span class="o">&gt;</span>
  <span class="n">password</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">YOUR_PASSWORD</span><span class="o">&gt;</span>

<span class="n">mqtt</span><span class="p">:</span>
  <span class="n">broker</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">YOUR_MQTT_BROKER</span><span class="o">&gt;</span>
  <span class="n">username</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">YOUR_USERNAME</span><span class="o">&gt;</span>
  <span class="n">password</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">YOUR_PASSWORD</span><span class="o">&gt;</span>

<span class="n">logger</span><span class="p">:</span>

<span class="n">ota</span><span class="p">:</span>
</pre></div></div><p>Now run <code class="docutils literal notranslate"><span class="pre">esphomeyaml</span> <span class="pre">sonoff_s20.yaml</span> <span class="pre">compile</span></code> to validate the configuration and pre-compile the firmware.<div class="admonition note"><p class="first admonition-title">Note<p class="last">After this step, you will be able to find the compiled binary under <code class="docutils literal notranslate"><span class="pre">&lt;NAME_OF_NODE&gt;/.pioenvs/&lt;NAME_OF_NODE&gt;/firmware.bin</span></code>. If you’re having trouble with uploading, you can also try uploading this file directly with other tools.</div></div><div class="section"id="step-4-uploading-firmware"><h2>Step 4: Uploading Firmware<a class="headerlink"href="#step-4-uploading-firmware"title="Permalink to this headline">¶</a></h2><p>In order to upload the firmware, you’re first going to need to get the chip into a flash mode, otherwise the device will start up without accepting any firmware flash attempts. To do this, while the device is UART bridge is not connected to your USB port, start pressing the small push button in the middle of the PCB. Then plug in the UART bridge into your computer and just keep holding the button pressed for 2-4 seconds. The S20 should now be in a flash mode and should not blink with any LED.<p>Now you can finally run the upload command:<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">esphomeyaml</span> <span class="n">sonoff_s20</span><span class="o">.</span><span class="n">yaml</span> <span class="n">run</span>
</pre></div></div><p>If successful, you should see something like this:<div class="figure align-center"><img alt="../../_images/sonoff_s20_upload.png"src="../../_images/sonoff_s20_upload.png"></div><p>Hooray 🎉! You’ve now successfully uploaded the first esphomeyaml firmware to your Sonoff S20. And in a moment, you will be able to use all of esphomeyaml’s great features with your Sonoff S20.<p>If above step does, however, not work, here are some steps that can help:<ul class="simple"><li>Sometimes the UART bridge cannot supply enough current to the chip to operate, in this case use a 3.3V supply you have lying around. A nice hack is to use the power supply of NodeMCU boards. Simply connect 3.3V to VCC and GND to GND on the pins. <strong>Do not attempt to plug the device into a socket to overcome this problem while troubleshooting.</strong><li>In other cases the <code class="docutils literal notranslate"><span class="pre">TX</span></code> and <code class="docutils literal notranslate"><span class="pre">RX</span></code> pin are reversed. Simple disconnect the device, swap the two pins and put it into flash mode again.</ul></div><div class="section"id="step-5-adding-the-button-relay-and-leds"><h2>Step 5: Adding the Button, Relay and LEDs<a class="headerlink"href="#step-5-adding-the-button-relay-and-leds"title="Permalink to this headline">¶</a></h2><p>Now we would like the S20 to actually do something, not just connect to WiFi and pretty much sit idle.<p>Below you will find a table of all usable GPIO pins of the S20 and a configuration file that exposes all of the basic functions.<table border="1"class="no-center docutils"><col width="50%"><col width="50%"><tbody valign="top"><tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">GPIO0</span></code><td>Push Button (HIGH = off, LOW = on)<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">GPIO12</span></code><td>Relay and its status LED<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">GPIO13</span></code><td>Green LED (HIGH = off, LOW = on)<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">GPIO1</span></code><td><code class="docutils literal notranslate"><span class="pre">RX</span></code> pin (for external sensors)<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">GPIO3</span></code><td><code class="docutils literal notranslate"><span class="pre">TX</span></code> pin (for external sensors)</table><div class="code yaml highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">esphomeyaml</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">NAME_OF_NODE</span><span class="o">&gt;</span>
  <span class="n">platform</span><span class="p">:</span> <span class="n">ESP8266</span>
  <span class="n">board</span><span class="p">:</span> <span class="n">esp01_1m</span>
  <span class="n">board_flash_mode</span><span class="p">:</span> <span class="n">dout</span>

<span class="n">wifi</span><span class="p">:</span>
  <span class="n">ssid</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">YOUR_SSID</span><span class="o">&gt;</span>
  <span class="n">password</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">YOUR_PASSWORD</span><span class="o">&gt;</span>

<span class="n">mqtt</span><span class="p">:</span>
  <span class="n">broker</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">YOUR_MQTT_BROKER</span><span class="o">&gt;</span>
  <span class="n">username</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">YOUR_USERNAME</span><span class="o">&gt;</span>
  <span class="n">password</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">YOUR_PASSWORD</span><span class="o">&gt;</span>

<span class="n">logger</span><span class="p">:</span>

<span class="n">ota</span><span class="p">:</span>

<span class="n">binary_sensor</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">platform</span><span class="p">:</span> <span class="n">gpio</span>
    <span class="n">pin</span><span class="p">:</span>
      <span class="n">number</span><span class="p">:</span> <span class="n">GPIO0</span>
      <span class="n">mode</span><span class="p">:</span> <span class="n">INPUT_PULLUP</span>
      <span class="n">inverted</span><span class="p">:</span> <span class="kc">True</span>
    <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;Sonoff S20 Button&quot;</span>
  <span class="o">-</span> <span class="n">platform</span><span class="p">:</span> <span class="n">status</span>
    <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;Sonoff S20 Status&quot;</span>


<span class="n">switch</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">platform</span><span class="p">:</span> <span class="n">gpio</span>
    <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;Sonoff S20 Relay&quot;</span>
    <span class="n">pin</span><span class="p">:</span> <span class="n">GPIO12</span>

<span class="n">output</span><span class="p">:</span>
  <span class="c1"># Register the green LED as a dimmable output ....</span>
  <span class="o">-</span> <span class="n">platform</span><span class="p">:</span> <span class="n">esp8266_pwm</span>
    <span class="nb">id</span><span class="p">:</span> <span class="n">s20_green_led</span>
    <span class="n">pin</span><span class="p">:</span> <span class="n">GPIO13</span>
    <span class="n">inverted</span><span class="p">:</span> <span class="kc">True</span>

<span class="n">light</span><span class="p">:</span>
  <span class="c1"># ... and then make a light out of it.</span>
  <span class="o">-</span> <span class="n">platform</span><span class="p">:</span> <span class="n">monochromatic</span>
    <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;Sonoff S20 Green LED&quot;</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">s20_green_led</span>
</pre></div></div><p>Above example also showcases an important concept of esphomeyaml: IDs and linking. In order to make all components in esphomeyaml as much “plug and play” as possible, you can use IDs to define them in one area, and simply pass that ID later on. For example, above you can see an PWM (dimmer) output being created with the ID <code class="docutils literal notranslate"><span class="pre">s20_green_led</span></code> for the green LED. Later on it is then transformed into a <a class="reference internal"href="../components/light/monochromatic.html"><span class="doc">monochromatic light</span></a>.<p>And if you want the thing that’s connected through the output of the S20 to appear as a light in Home Assistant, replace the last part with this:<div class="code yaml highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">switch</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">platform</span><span class="p">:</span> <span class="n">restart</span>
    <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;Sonoff S20 Restart&quot;</span>

<span class="n">output</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">platform</span><span class="p">:</span> <span class="n">esp8266_pwm</span>
    <span class="nb">id</span><span class="p">:</span> <span class="n">s20_green_led</span>
    <span class="n">pin</span><span class="p">:</span>
      <span class="n">number</span><span class="p">:</span> <span class="n">GPIO13</span>
    <span class="n">inverted</span><span class="p">:</span> <span class="kc">True</span>
  <span class="c1"># Note: do *not* make the relay a dimmable (PWM) signal, relays cannot handle that</span>
  <span class="o">-</span> <span class="n">platform</span><span class="p">:</span> <span class="n">binary</span>
    <span class="nb">id</span><span class="p">:</span> <span class="n">s20_relay</span>
    <span class="n">pin</span><span class="p">:</span> <span class="n">GPIO12</span>

<span class="n">light</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">platform</span><span class="p">:</span> <span class="n">monochromatic</span>
    <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;Sonoff S20 Green LED&quot;</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">s20_green_led</span>
  <span class="o">-</span> <span class="n">platform</span><span class="p">:</span> <span class="n">binary</span>
    <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;Sonoff S20 Relay&quot;</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">s20_relay</span>
</pre></div></div><p>To make pressing the button on the front toggle the relay, have a look at the <a class="reference external"href="https://github.com/OttoWinter/esphomeyaml/blob/master/examples/sonoff_s20.yaml">the complete Sonoff S20 with automation example</a>.<p>Upload the firmware again (through OTA or Serial) and you should immediately see something like this in Home Assistant because of esphomeyaml’s automatic MQTT discovery. (You’ll of course have to add them to groups if you have a <code class="docutils literal notranslate"><span class="pre">default_view</span></code> set):<div class="figure align-center"><a class="reference internal image-reference"href="../../_images/sonoff_s20_result.png"><img alt="../../_images/sonoff_s20_result.png"src="../../_images/sonoff_s20_result.png"style="width: 75.0%;"></a></div></div><div class="section"id="step-6-finishing-up"><h2>Step 6: Finishing Up<a class="headerlink"href="#step-6-finishing-up"title="Permalink to this headline">¶</a></h2><p>Now you’re pretty much done with setting up the Sonoff S20. The only steps left are to remove any cables within the housing and make sure everyhing in there is clean. If, for example, you used wires to connect the UART console, you should definitely remove them to avoid a short with mains.<p>Sometimes the soldered-on header pins can also interfere with the button. It’s best to remove the header pins again, as you will hopefully not need to use them again because of esphomeyaml’s Over-The-Air Update features (+ the OTA safe mode; if your node reboots more than 10 times in a row, it will automatically enter an OTA-only safe mode).<p>If you’re sure everything is done with the S20 and have double checked there’s nothing that could cause a short in the case, you can put the front cover with the button on the base again and screw everything together.<p>Now triple or even quadruple check the UART bridge is not connected to the S20, then comes the time when you can plug it into the socket.<p>Happy hacking!</div><div class="section"id="see-also"><h2>See Also<a class="headerlink"href="#see-also"title="Permalink to this headline">¶</a></h2><ul class="simple"><li><a class="reference internal"href="sonoff.html"><span class="doc">Generic Sonoff</span></a><li><a class="reference internal"href="sonoff_4ch.html"><span class="doc">Using With Sonoff 4CH</span></a><li><a class="reference external"href="https://github.com/OttoWinter/esphomedocs/blob/current/esphomeyaml/devices/sonoff_s20.rst">Edit this page on GitHub</a></ul></div></div></div></div></div><div class="sphinxsidebar"role="navigation"aria-label="main navigation"><div class="sphinxsidebarwrapper"><div class="relations"><h3>Related Topics</h3><ul><li><a href="../../index.html">Documentation overview</a><ul><li><a href="../index.html">esphomeyaml</a><ul><li><a href="index.html">Cookbook</a><ul><li>Previous: <a href="sonoff_4ch.html"title="previous chapter">Using With Sonoff 4CH</a><li>Next: <a href="sonoff_basic.html"title="next chapter">Using With Sonoff Basic</a></ul></ul></ul></ul></div><div id="searchbox"style="display: none"role="search"><h3>Quick search</h3><div class="searchformwrapper"><form class="search"action="../../search.html"><input name="q"> <input type="submit"value="Go"> <input type="hidden"name="check_keywords"value="yes"> <input type="hidden"name="area"value="default"></form></div></div><script>$('#searchbox').show(0);</script></div></div><div class="clearer"></div></div><div class="footer">&copy;2018, Otto Winter. | Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.2</a> &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a> | <a href="../../_sources/esphomeyaml/devices/sonoff_s20.rst.txt"rel="nofollow">Page source</a></div>